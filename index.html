<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- <link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico"> -->
  <!--
      Notice the use of %PUBLIC_URL% in the tag above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
  <title>React App</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
    }

    .nyserda-options {
      position: absolute;
      left: 12px;
      top: 7rem;
      padding: 1rem;
      z-index: 9999999;
      background-color: white;
      border: 1px solid black;
      box-shadow: 5px 5px 2.5px #888888;
    }

    .nyserda-data-selector {
      margin: 1rem 0;
    }

    .nyserda-data-selector select {
      width: 100%;
      height: 2rem;
      font-size: 1.2rem;
    }

    .nyserda-layer-selector {
      margin: 1rem 0;
    }

    .nyserda-layer-checkbox {
      display: block;
      padding: .25rem 0;
    }

    .nyserda-legend {
      position: absolute;
      right: 16px;
      top: 7rem;
      z-index: 9999999;
      border: 1px solid black;
      box-shadow: 5px 5px 2.5px #888888;
    }

    .nyserda-lat-lng {
      position: absolute;
      right: 0;
      top: 0;
      padding: .5rem;
      z-index: 9999999;
      background-color: white;
    }

    .nyserda-lat-lng-container {
      display: inline-block;
      padding: .25rem;
    }

    .nyserda-version-id {
      position: absolute;
      right: 0;
      bottom: 0;
      background-color: white;
      z-index: 9999999;
    }

    #mapid {
      min-height: 800px;
      height: 100vh;
      width: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div class="nyserda-options">
    <div class="nyserda-data-selector">
      <select name="data-selector" id="data-selector">
        <option value="" hidden>Select an area</option>
        <option value="nassau">Nassau</option>
        <option value="nyc">New York City</option>
        <option value="westchester">Westchester</option>
      </select>
    </div>

    <div class="nyserda-layer-selector" id="nyserda-layers-container"></div>
  </div>

  <div class="nyserda-legend">
    <img src="./Probability.PNG" alt="legend">
  </div>

  <div class="nyserda-lat-lng">
    <div class="nyserda-lat-lng-container"><label for="nyserda-lat">Lat:</label><span id="nyserda-lat"></span></div>
    <div class="nyserda-lat-lng-container"><label for="nyserda-lng">Lng:</label><span id="nyserda-lng"></span></div>
    <div class="nyserda-lat-lng-container"><label for="nyserda-zoom">Zoom:</label><span id="nyserda-zoom"></span></div>
  </div>

  <div class="nyserda-version-id">1.1</div>

  <div id="mapid"></div>

  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  <script src='./leaflet.filelayer.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
  <script>
    const app = {};
    app.map = false;
    app.currentSelection = false;
    app.selectorEle = document.getElementById('data-selector');
    app.layerListEle = document.getElementById('nyserda-layers-container');
    app.checkboxes = false;
    app.baseUrl = 'https://bryanneva-erg.github.io/nyserda-map/';
    app.data = {
      nassau: '/Nassau/Nassau.json',
      nyc: '/NewYorkCity/NewYorkCity.json',
      westchester: '/Westchester/Westchester.json',
    };
    app.zoom = {
      default: 10,
      nassau: 11,
      nyc: 11,
      westchester: 13,
    };
    app.center = {
      default: [40.7993, -73.6853],
      nassau: [40.7202, -73.6208],
      nyc: [40.6983, -73.9490],
      westchester: [40.9314, -73.7394],
    };
    app.layers = {
      nassau: false,
      nyc: false,
      westchester: false,
    };
    app.sublayers = {
      nassau: false,
      nyc: false,
      westchester: false,
    };
    app.organizedRasters = {
      nassau: false,
      nyc: false,
      westchester: false,
    }
    app.groups = {
      nassau: [],
      nyc: [],
      westchester: [],
    };

    app.selectorEle.addEventListener('change', function(e) {
      setViewPort(e.target.value);
      populateMap(e.target.value)
    });

    function setViewPort(dataSet) {
      if (app.currentSelection) {
        Object.keys(app.sublayers[app.currentSelection]).forEach(key => app.map.removeLayer(app.sublayers[app.currentSelection][key]));
      }

      app.currentSelection = dataSet;
      app.map.setView(app.center[dataSet], app.zoom[dataSet])
    }

    function bindCheckboxEvents(cb) {
      app.checkboxes = document.getElementsByClassName('nyserda-layer-checkbox');
      for (var i = 0; i < app.checkboxes.length; i++) {
        app.checkboxes[i].addEventListener('change', cb);
      }
    }

    function onChangeLayer(e) {
      const layer = app.sublayers[app.currentSelection][e.target.id];

      if (e.target.checked) {
        app.map.addLayer(layer);
      } else {
        app.map.removeLayer(layer)
      }

      // app.map.on("zoomstart", function() {
      //   var zoomLevel = app.map.getZoom();
      //   // console.log('zoomstart', zoomLevel, layer);
      //   if (zoomLevel > 9) {
      //     app.map.addLayer(layer);
      //   } else {
      //     app.map.removeLayer(layer)
      //   }
      // });
    }

    function initializeMap(dataSet) {
      app.map = L.map('mapid', {
        center: app.center[dataSet],
        zoom: app.zoom[dataSet]
      }).setView(app.center[dataSet], app.zoom[dataSet]);

      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18,
        id: 'bryanneva.oclj42hm',
        accessToken: 'pk.eyJ1IjoiYnJ5YW5uZXZhIiwiYSI6ImNpaHo4anBwaTA0NGJ0Z20xNWFzc2p0a2wifQ.YrgNYNaTMTiK7NkHD8z0yQ'
      }).addTo(app.map);

      app.map.on("click", function() {
        const zoom = app.map.getZoom();
        const center = app.map.getCenter();
        document.getElementById('nyserda-lat').textContent = center.lat;
        document.getElementById('nyserda-lng').textContent = center.lng;
        document.getElementById('nyserda-zoom').textContent = zoom;
      });
    }

    function populateLayerList(dataSet) {
      const layers = app.groups[dataSet];
      let html = layers
        .map(layer => ({
          slug: layer,
          text: layer.replace(/([A-Z])/g, " $1").replace(/(^.+)(\w\d+\w)(.+$)/g, "$1 $2$3"),
        }))
        .map(layer => {
          let ele = "<label for='" + layer.slug + "' class='nyserda-layer-checkbox'>";
          ele += "<input type='checkbox' id='" + layer.slug + "'>";
          ele += layer.text + "</label>";

          return ele;
        })
        .join('');

      app.layerListEle.innerHTML = html;

      bindCheckboxEvents(onChangeLayer);
    }

    function populateMap(dataSet) {
      const url = app.baseUrl + app.data[dataSet];
      console.warn('url',url);
      fetch(url)
        .then(response => response.json())
        .then(json => json.features.map(data => ({
          path: '.' + data.properties.image_overlay,
          bounds: data.geometery.coordinates,
          group: data.properties.group,
        })))
        .then(json => {
          console.log('json',json);
          return json;
        })
        .then(rasters => {

          let groups = app.groups[dataSet];
          if (groups.length === 0) {
            app.groups[dataSet] = rasters.map(r => r.group).filter((r, index, array) => array.indexOf(r) === index);
          }

          app.organizedRasters[dataSet] = {};
          app.groups[dataSet].forEach(group => app.organizedRasters[dataSet][group] = []);
          rasters.forEach(raster => app.organizedRasters[dataSet][raster.group].push(raster));

          app.sublayers[dataSet] = {};
          let firstExisting = false;
          let firstCoastal = false;
          app.groups[dataSet].forEach((group, index) => {
            firstExisting = index === 0 ? group : firstExisting;
            firstCoastal = group.indexOf('NewCoastalMarsh') === 0 && firstCoastal === false ? group : firstCoastal;

            app.sublayers[dataSet][group] = L.layerGroup(app.organizedRasters[dataSet][group].map(raster => L.imageOverlay(raster.path, raster.bounds)));
          });


        //   app.map.addLayer(app.sublayers[dataSet][firstExisting]);
        //   app.map.addLayer(app.sublayers[dataSet][firstCoastal]);
          app.map.addLayer(app.sublayers[dataSet].ExistingMarsh2100);
          app.map.addLayer(app.sublayers[dataSet].NewCoastalMarsh2100);

          populateLayerList(dataSet);

        //   document.getElementById(firstExisting).checked = true;
        //   document.getElementById(firstCoastal).checked = true;
          document.getElementById('ExistingMarsh2100').checked = true;
          document.getElementById('NewCoastalMarsh2100').checked = true;
        });
    }

    initializeMap('default');
    // populateMap('nassau');
  </script>
</body>

</html>
